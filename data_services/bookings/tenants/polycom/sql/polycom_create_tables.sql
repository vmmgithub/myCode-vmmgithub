create database if not exists polycom_data;
use polycom_data;
DROP TABLE IF EXISTS DELIVERY_OF_DAILY_ORDERS_ACTIVITY;
CREATE TABLE IF NOT EXISTS DELIVERY_OF_DAILY_ORDERS_ACTIVITY (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	AGREE_PO	varchar(30),
	AGREE_SO	varchar(30),
	AGREE_ACCNT_NAME	varchar(100),
	AGREE_LINE_SERVICE_PART_NUM	varchar(50),
	AGREE_LINE_SERVICE_PRODUCT	varchar(100),
	AGREE_LINE_PRODUCT_GROUP	varchar(30),
	AGREE_SHIP_ACCNT_NAME	varchar(100),
	INVOICE_DATE	date,
	INVOICE_NUM	varchar(30),
	SO_CURRENCY	varchar(30),
	SO_DATE	date,
	SO_EXT_NET_PRICE_USD	decimal(28,10),
	SO_EXT_NET_PRICE	decimal(28,10),
	DOC_CURR_CODE	varchar(30),
	LOC_CURR_CODE	varchar(30),
	SS_IMPORT_DT	date,
	SS_STATUS	varchar(30) NOT NULL DEFAULT 'Not Processed',
	SS_PROCESSED_DT timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	KEY ix_status (SS_STATUS)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;

DROP TABLE IF EXISTS REACTIVATED_AGREE_PO;
CREATE TABLE IF NOT EXISTS REACTIVATED_AGREE_PO (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	AGREE_PO	varchar(100),
	SS_PROCESSED_DT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	UNIQUE KEY ix_agree_po (AGREE_PO)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;

DROP TABLE IF EXISTS ENTITLEMENT_DAILY_ACTIVITY;
CREATE TABLE IF NOT EXISTS ENTITLEMENT_DAILY_ACTIVITY (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	AGREE_ID	varchar(100),
	AGREE_NAME	varchar(100),
	AGREE_NUM	varchar(100),
	AGREE_PO	varchar(100),
	AGREE_SALES_REGION	varchar(100),
	THEATER	varchar(100),
	AGREE_SO	varchar(100),
	NO_OF_ASSET_ENTL_ON_LINE	integer,
	AGREE_LINE_ID	varchar(100),
	AGREE_LINE_NUM	integer,
	AGREE_LINE_PART_LIST	integer,
	AGREE_LINE_PART_NET	decimal(28,10),
	AGREE_LINE_PART_NET_PER_ASSET	decimal(28,10),
	ANNUALIZED_VALUE	varchar(100),
	AGREE_LINE_QTY	integer,
	AGREE_LINE_CURRENCY	varchar(100),
	MSRP	varchar(100),
	MKTG_NAME	varchar(100),
	DISCOUNT_CODE	varchar(100),
	BUNDLE_PART_TRNS	varchar(100),
	AGREE_LINE_SERVICE_PART_NUM	varchar(100),
	PIM_DESCRIPTION	varchar(250),
	ASSET_NUM	varchar(150),
	ASSET_ID	varchar(100),
	ASSET_PO_NUM	varchar(100),
	ASSET_SERIAL_NUM	varchar(100),
	ASSET_SERVICE_REGION	varchar(100),
	ASSET_SHIP_DATE	date,
	ASSET_SHIP_YEAR	varchar(100),
	ASSET_SO_NUM	varchar(100),
	ASSET_ADDRESS_1	varchar(100),
	ASSET_ADDRESS_2	varchar(100),
	ASSET_ADDRESS_ID	varchar(100),
	ASSET_CITY	varchar(100),
	ASSET_COUNTRY	varchar(100),
	ASSET_POSTAL	varchar(100),
	ASSET_STATE	varchar(100),
	ASSET_PART_NUM	varchar(100),
	ASSET_PRODUCT	varchar(150),
	ASSET_PRODUCT_DIVISION	varchar(100),
	ASSET_PRODUCT_GROUP	varchar(100),
	ASSET_MASTER_PRODUCT_GROUP	varchar(100),
	EOSL	varchar(100),
	ASSET_PRODUCT_ID	varchar(100),
	ASSET_PRODUCT_LINE	varchar(100),
	ENTL_CREATE_DATE	date,
	ENTL_DELIVERY_TYPE	varchar(100),
	ENTL_END_DATE	date,
	ENTL_BATCH_QUARTER	varchar(100),
	ENTL_ID	varchar(100),
	ENTL_NAME	varchar(100),
	ENTL_NET_PRICE_PER_ASSET	decimal(28,10),
	ENTL_NET_PRICE_PER_ASSET_USD	decimal(28,10),
	ENTL_SERVICE_TYPE	varchar(100),
	ENTL_ST_DATE	date,
	PREV_AGREE_ID	varchar(100),
	PREV_ENTL_END	varchar(100),
	PREV_ENTL_PO	varchar(100),
	PREV_ENTL_SRVC_PART_NUM	varchar(100),
	PREV_ENTITLEMENT_ID	varchar(100),
	SO_CURRENCY	varchar(100),
	SO_DATE	date,
	SO_EXT_NET_PRICE	decimal(28,10),
	SO_EXT_NET_PRICE_USD	decimal(28,10),
	AGREE_ACCNT_ID	varchar(100),
	AGREE_ACCNT_NAME	varchar(100),
	AGREE_MASTER_ACCNT_ID	varchar(100),
	AGREE_MSTR_ACCNT_NAME	varchar(100),
	AGREE_ACCNT_GAN	varchar(100),
	AGREE_ACCNT_ADDRESS_1	varchar(100),
	AGREE_ACCNT_ADDRESS_2	varchar(100),
	AGREE_ACCNT_ADDRESS_ID	varchar(100),
	AGREE_ACCNT_CITY	varchar(100),
	AGREE_ACCNT_COUNTRY	varchar(100),
	AGREE_ACCNT_POSTAL	varchar(100),
	AGREE_ACCNT_STATE	varchar(100),
	AGREE_ACCNT_CONTACT_EMAIL	varchar(150),
	AGREE_ACCNT_CONTACT_NAME	varchar(100),
	AGREE_ACCNT_CONTACT_PHONE	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_ACCNT_PGS_CONTACT_FIRST	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_ID	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_LAST	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_PHONE	varchar(100),
	AGREE_END_CUST_ID	varchar(100),
	AGREE_END_CUST_MSTR_ID	varchar(100),
	AGREE_END_CUST_NAME	varchar(100),
	AGREE_END_CUST_MSTR_NAME	varchar(100),
	AGREE_END_CUST_ADDRESS_1	varchar(100),
	AGREE_END_CUST_ADDRESS_2	varchar(100),
	AGREE_END_CUST_ADDRESS_ID	varchar(100),
	AGREE_END_CUST_CITY	varchar(100),
	AGREE_END_CUST_COUNTRY	varchar(100),
	AGREE_END_CUST_POSTAL	varchar(100),
	AGREE_END_CUST_STATE	varchar(100),
	AGREE_END_CUST_CONTACT_EMAIL	varchar(150),
	AGREE_END_CUST_CONTACT_NAME	varchar(100),
	AGREE_END_CUST_CONTACT_PHONE	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_END_CUST_PGS_CONTACT_FIRST	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_ID	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_LAST	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_PHONE	varchar(100),
	AGREE_RES_MASTER_ACCNT_ID	varchar(100),
	AGREE_RES_ACCNT_NAME	varchar(100),
	AGREE_RES_ACCT_MSTR_NAME	varchar(100),
	AGREE_RES_ID	varchar(100),
	AGREE_RES_ADDRESS_1	varchar(100),
	AGREE_RES_ADDRESS_2	varchar(100),
	AGREE_RES_ADDRESS_ID	varchar(100),
	AGREE_RES_CITY	varchar(100),
	AGREE_RES_COUNTRY	varchar(100),
	AGREE_RES_POSTAL	varchar(100),
	AGREE_RES_STATE	varchar(100),
	AGREE_RES_CONTACT_EMAIL	varchar(100),
	AGREE_RES_CONTAC_NAME	varchar(100),
	AGREE_RES_CONTACT_PHONE	varchar(100),
	AGREE_RES_PGS_CONTACT_EMAIL	varchar(100),
	AGREE_RES_PGS_CONTACT_FIRST	varchar(100),
	AGREE_RES_PGS_CONTACT_ID	varchar(100),
	AGREE_RES_PGS_CONTACT_LAST	varchar(100),
	AGREE_RES_PGS_CONTACT_PHONE	varchar(100),
	AGREE_SHIP_ACCNT_NAME	varchar(100),
	AGREE_SHIP_ID	varchar(100),
	AGREE_SHIP_ADDRESS_1	varchar(100),
	AGREE_SHIP_ADDRESS_2	varchar(100),
	AGREE_SHIP_ADDRESS_ID	varchar(100),
	AGREE_SHIP_CITY	varchar(100),
	AGREE_SHIP_COUNTRY	varchar(100),
	AGREE_SHIP_POSTAL	varchar(100),
	AGREE_SHIP_STATE	varchar(100),
	AGREE_SHIP_CONTACT_EMAIL	varchar(100),
	AGREE_SHIP_CONTACT_NAME	varchar(100),
	AGREE_SHIP_CONTACT_PHONE	varchar(100),
	AGREE_SHIP_PGS_CONTACT_EMAIL	varchar(100),
	AGREE_SHIP_PGS_CONTACT_FIRST	varchar(100),
	AGREE_SHIP_PGS_CONTACT_ID	varchar(100),
	AGREE_SHIP_PGS_CONTACT_LAST	varchar(100),
	AGREE_SHIP_PGS_CONTACT_PHONE	varchar(100),
	ASSET_OWNER_ACCNT_NAME	varchar(100),
	ASSET_OWNER_ID	varchar(100),
	ASSET_OWNER_ADDRESS_1	varchar(100),
	ASSET_OWNER_ADDRESS_2	varchar(100),
	ASSET_OWNER_ADDRESS_ID	varchar(100),
	ASSET_OWNER_CITY	varchar(100),
	ASSET_OWNER_COUNTRY	varchar(100),
	ASSET_OWNER_POSTAL	varchar(100),
	ASSET_OWNER_STATE	varchar(100),
	ASSET_CONTACT_EMAIL	varchar(150),
	ASSET_CONTACT_FIRST	varchar(100),
	ASSET_CONTACT_ID	varchar(100),
	ASSET_CONTACT_LAST	varchar(100),
	ASSET_CONTACT_PHONE	varchar(100),
	ASSET_STATUS	varchar(100),
	POLYCOM_TERRITORY	varchar(100),
	PORTAL_PRIMARY_AGREE_NAME	varchar(100),
	PORTAL_PRIMARY_AGREE_ID	varchar(100),
	SS_IMPORT_DT	date,
	SS_STATUS	varchar(30) NOT NULL DEFAULT 'Not Processed',
	SS_PROCESSED_DT timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	KEY	ix_status (SS_STATUS),
	KEY	ix_agree_line (AGREE_LINE_PART_NET_PER_ASSET),
	KEY	ix_entitlement_key (ASSET_ID,PREV_ENTITLEMENT_ID,PREV_ENTL_SRVC_PART_NUM)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;

DROP TABLE IF EXISTS ENTITLEMENT_DAILY_ACTIVITY_EXCEPTION;
CREATE TABLE IF NOT EXISTS ENTITLEMENT_DAILY_ACTIVITY_EXCEPTION (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	AGREE_ID	varchar(30),
	AGREE_NAME	varchar(100),
	AGREE_NUM	varchar(30),
	AGREE_PO	varchar(30),
	AGREE_SALES_REGION	varchar(100),
	AGREE_SO	varchar(30),
	NO_OF_ASSET_ENTL_ON_LINE	Integer,
	AGREE_LINE_ID	varchar(30),
	AGREE_LINE_NUM	Integer,
	AGREE_LINE_PART_LIST	Integer,
	AGREE_LINE_PART_NET	decimal(28,10),
	AGREE_LINE_PART_NET_PER_ASSET	decimal(28,10),
	AGREE_LINE_QTY	Integer,
	AGREE_LINE_CURRENCY	varchar(30),
	AGREE_LINE_SERVICE_PART_NUM	varchar(50),
	AGREE_LINE_SERVICE_PRODUCT	varchar(150),
	ASSET_NUM	varchar(150),
	ASSET_ID	varchar(30),
	ASSET_PO_NUM	varchar(30),
	ASSET_SERIAL_NUM	varchar(30),
	ASSET_SERVICE_REGION	varchar(20),
	ASSET_SHIP_DATE	date,
	ASSET_SO_NUM	varchar(30),
	ASSET_ADDRESS_1	varchar(90),
	ASSET_ADDRESS_2	varchar(90),
	ASSET_ADDRESS_ID	varchar(30),
	ASSET_CITY	varchar(100),
	ASSET_COUNTRY	varchar(100),
	ASSET_POSTAL	varchar(30),
	ASSET_STATE	varchar(50),
	ASSET_PART_NUM	varchar(50),
	ASSET_PRODUCT	varchar(150),
	ASSET_PRODUCT_DIVISION	varchar(30),
	ASSET_PRODUCT_GROUP	varchar(30),
	ASSET_PRODUCT_ID	varchar(30),
	ASSET_PRODUCT_LINE	varchar(30),
	ENTL_CREATE_DATE	date,
	ENTL_DELIVERY_TYPE	varchar(30),
	ENTL_END_DATE	date,
	ENTL_ID	varchar(30),
	ENTL_NAME	varchar(100),
	ENTL_NET_PRICE_PER_ASSET	decimal(28,10),
	ENTL_NET_PRICE_PER_ASSET_USD	decimal(28,10),
	ENTL_SERVICE_TYPE	varchar(30),
	ENTL_ST_DATE	date,
	PREV_AGREE_ID	varchar(30),
	PREV_ENTL_END	varchar(30),
	PREV_ENTL_PO	varchar(30),
	SO_CURRENCY	varchar(30),
	SO_DATE	date,
	SO_EXT_NET_PRICE	decimal(28,10),
	SO_EXT_NET_PRICE_USD	decimal(28,10),
	AGREE_ACCNT_ID	varchar(30),
	AGREE_ACCNT_NAME	varchar(100),
	AGREE_ACCNT_GAN	varchar(100),
	AGREE_ACCNT_ADDRESS_1	varchar(90),
	AGREE_ACCNT_ADDRESS_2	varchar(90),
	AGREE_ACCNT_ADDRESS_ID	varchar(30),
	AGREE_ACCNT_CITY	varchar(100),
	AGREE_ACCNT_COUNTRY	varchar(100),
	AGREE_ACCNT_POSTAL	varchar(30),
	AGREE_ACCNT_STATE	varchar(50),
	AGREE_ACCNT_CONTACT_EMAIL	varchar(150),
	AGREE_ACCNT_CONTACT_NAME	varchar(150),
	AGREE_ACCNT_CONTACT_PHONE	varchar(30),
	AGREE_ACCNT_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_ACCNT_PGS_CONTACT_FIRST	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_ID	varchar(30),
	AGREE_ACCNT_PGS_CONTACT_LAST	varchar(100),
	AGREE_ACCNT_PGS_CONTACT_PHONE	varchar(30),
	AGREE_END_CUST_ID	varchar(30),
	AGREE_END_CUST_NAME	varchar(100),
	AGREE_END_CUST_ADDRESS_1	varchar(90),
	AGREE_END_CUST_ADDRESS_2	varchar(90),
	AGREE_END_CUST_ADDRESS_ID	varchar(30),
	AGREE_END_CUST_CITY	varchar(100),
	AGREE_END_CUST_COUNTRY	varchar(50),
	AGREE_END_CUST_POSTAL	varchar(30),
	AGREE_END_CUST_STATE	varchar(50),
	AGREE_END_CUST_CONTACT_EMAIL	varchar(150),
	AGREE_END_CUST_CONTACT_NAME	varchar(100),
	AGREE_END_CUST_CONTACT_PHONE	varchar(30),
	AGREE_END_CUST_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_END_CUST_PGS_CONTACT_FIRST	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_ID	varchar(30),
	AGREE_END_CUST_PGS_CONTACT_LAST	varchar(100),
	AGREE_END_CUST_PGS_CONTACT_PHONE	varchar(30),
	AGREE_RES_ACCNT_NAME	varchar(100),
	AGREE_RES_ID	varchar(30),
	AGREE_RES_ADDRESS_1	varchar(90),
	AGREE_RES_ADDRESS_2	varchar(90),
	AGREE_RES_ADDRESS_ID	varchar(30),
	AGREE_RES_CITY	varchar(100),
	AGREE_RES_COUNTRY	varchar(100),
	AGREE_RES_POSTAL	varchar(30),
	AGREE_RES_STATE	varchar(50),
	AGREE_RES_CONTACT_EMAIL	varchar(150),
	AGREE_RES_CONTAC_NAME	varchar(100),
	AGREE_RES_CONTACT_PHONE	varchar(30),
	AGREE_RES_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_RES_PGS_CONTACT_FIRST	varchar(100),
	AGREE_RES_PGS_CONTACT_ID	varchar(30),
	AGREE_RES_PGS_CONTACT_LAST	varchar(100),
	AGREE_RES_PGS_CONTACT_PHONE	varchar(30),
	AGREE_SHIP_ACCNT_NAME	varchar(100),
	AGREE_SHIP_ID	varchar(30),
	AGREE_SHIP_ADDRESS_1	varchar(90),
	AGREE_SHIP_ADDRESS_2	varchar(90),
	AGREE_SHIP_ADDRESS_ID	varchar(30),
	AGREE_SHIP_CITY	varchar(100),
	AGREE_SHIP_COUNTRY	varchar(50),
	AGREE_SHIP_POSTAL	varchar(30),
	AGREE_SHIP_STATE	varchar(50),
	AGREE_SHIP_CONTACT_EMAIL	varchar(150),
	AGREE_SHIP_CONTACT_NAME	varchar(100),
	AGREE_SHIP_CONTACT_PHONE	varchar(30),
	AGREE_SHIP_PGS_CONTACT_EMAIL	varchar(150),
	AGREE_SHIP_PGS_CONTACT_FIRST	varchar(100),
	AGREE_SHIP_PGS_CONTACT_ID	varchar(30),
	AGREE_SHIP_PGS_CONTACT_LAST	varchar(100),
	AGREE_SHIP_PGS_CONTACT_PHONE	varchar(30),
	ASSET_OWNER_ACCNT_NAME	varchar(100),
	ASSET_OWNER_ID	varchar(30),
	ASSET_OWNER_ADDRESS_1	varchar(90),
	ASSET_OWNER_ADDRESS_2	varchar(90),
	ASSET_OWNER_ADDRESS_ID	varchar(30),
	ASSET_OWNER_CITY	varchar(100),
	ASSET_OWNER_COUNTRY	varchar(50),
	ASSET_OWNER_POSTAL	varchar(30),
	ASSET_OWNER_STATE	varchar(50),
	ASSET_CONTACT_EMAIL	varchar(150),
	ASSET_CONTACT_FIRST	varchar(100),
	ASSET_CONTACT_ID	varchar(30),
	ASSET_CONTACT_LAST	varchar(100),
	ASSET_CONTACT_PHONE	varchar(30),
	SS_IMPORT_DT	date,
	SS_STATUS	varchar(30) NOT NULL DEFAULT 'Not Processed',
	SS_PROCESSED_DT	TIMESTAMP,
	EXCEPTION_REASON	varchar(100),
	PRIMARY KEY (TMP_ID),
	KEY ix_entitlement_key (ASSET_SERIAL_NUM, ASSET_ID, PREV_ENTL_END, PREV_AGREE_ID)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;


DROP TABLE IF EXISTS WEEKLY_DISASSOCIATED_ASSETS;
CREATE TABLE IF NOT EXISTS WEEKLY_DISASSOCIATED_ASSETS (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	INTEGRATION_ID	varchar(30),
	ASSET	varchar(30),
	ASSET_NUM	varchar(100),
	SERIAL_NUM	varchar(30),
	ENTITLEMENT	varchar(30),
	AGREEMENT	varchar(30),
	PRODUCT	varchar(30),
	AGREE_LINE_SERVICE_PART_NUM	varchar(30),
	OPERATION_CD	varchar(50),
	ASSET_DISASSOCIATION_DT	datetime,
	PROD_INT_ID	varchar(30),
	AGREEMENT_ITEM	varchar(30),
	AGREEMENT_VALID_FLG	varchar(5),
	AGREEMENT_ACCOUNT	varchar(30),
	ASSET_OWNER_ACCOUNT	varchar(30),
	ENTITLEMENT_START_DT	date,
	ENTITLEMENT_END_DT	date,
	AGREE_START_DT	date,
	AGREE_END_DT	date,
	SS_IMPORT_DT	date,
	SS_STATUS	varchar(30) NOT NULL DEFAULT 'Not Processed',
	SS_PROCESSED_DT	TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	KEY ix_status (SS_STATUS)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;

DROP TABLE IF EXISTS WEEKLY_UNINSTALL_ASSETS;
CREATE TABLE IF NOT EXISTS WEEKLY_UNINSTALL_ASSETS (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	ASSET_UNINSTALL_DATE	datetime,
	ASSET_NUMBER	varchar(100),
	ASSET_ID	varchar(30),
	ASSET_SHIP_DATE	date,
	ASSET_SERIAL_NUM	varchar(30),
	AGREE_ID	varchar(30),
	AGREE_LINE_ID	varchar(30),
	AGREE_LINE_SERVICE_PART_NUM	varchar(50),
	ENTL_ID	varchar(30),
	ENTL_END_DATE	date,
	SS_IMPORT_DT	date,
	SS_STATUS	varchar(30) NOT NULL DEFAULT 'Not Processed',
	SS_PROCESSED_DT	TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	KEY ix_status (SS_STATUS)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;

DROP TABLE IF EXISTS LOG;
CREATE TABLE IF NOT EXISTS LOG (
	TMP_ID	INTEGER NOT NULL AUTO_INCREMENT,
	TENANT	varchar(50),
	LOG	varchar(250),
	CREATE_DT	DATETIME DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (TMP_ID),
	KEY ix_create_dt (CREATE_DT)
) ENGINE=InnoDB DEFAULT CHARACTER SET utf8;



create database if not exists polycom_stg;
use polycom_stg;
DROP TABLE IF EXISTS ENTITLEMENT_DAILY_ACTIVITY;

use polycom;
/*
** VIEW OF OPPS AND THEIR CORRESPONDING ITEMS
*/
CREATE OR REPLACE VIEW OPP_CROSS_VIEW AS 
SELECT 
	OPP._ID OPPID,
	OPP.FLOWS_SALESSTAGES_STATE_NAME FLOWSTATE,
	OPP.EXTENSIONS_MASTER_CLIENTTHEATRE_VALUE_DISPLAYNAME THEATER,
	OPP.EXTENSIONS_MASTER_BATCHQUARTER_VALUE BATCHQUARTER,
	OPP.ISSUBORDINATE,
	OPP.AMOUNT_AMOUNT OPPAMT,
	OPP.TARGETAMOUNT_AMOUNT OPPTARGETAMT,
	QTR.RELNAME QTREL,
	QTR.DESTKEY QTID, -- QT.AMOUNT_AMOUNT QTAMT,
	OFFR.SOURCEKEY OFFID,
	OFF.AMOUNT_AMOUNT OFFAMT,
	OFF.TARGETAMOUNT_AMOUNT OFFTARAMT,
	ASSR.DESTKEY ASSID,
	ASS.AMOUNT_AMOUNT ASSAMT,
	ASS.ENDDATE ASSENDDATE
FROM APP_OPPORTUNITIES OPP
LEFT OUTER JOIN RELATIONSHIPS QTR ON 
	OPP._ID = QTR.SOURCEKEY 
	AND QTR.RELNAME in ('baseQuote', 'primaryQuote', 'latestQuote') 
	AND QTR.SOURCETABLE = 'APP_OPPORTUNITIES'
-- LEFT OUTER JOIN APP_QUOTES QT ON 
--  QTR.DESTKEY = QT._ID
LEFT OUTER JOIN RELATIONSHIPS OFFR ON 
	QTR.DESTKEY = OFFR.DESTKEY 
	AND OFFR.RELNAME = 'quote' 
	AND OFFR.SOURCETABLE = 'APP_OFFERS'
LEFT OUTER JOIN APP_OFFERS OFF ON 
	OFFR.DESTKEY = OFF._ID
LEFT OUTER JOIN RELATIONSHIPS ASSR ON 
	OFFR.SOURCEKEY = ASSR.SOURCEKEY
	AND ASSR.RELNAME = 'predecessor' 
	AND ASSR.SOURCETABLE = 'APP_OFFERS'
LEFT OUTER JOIN APP_ASSETS ASS ON 
	ASSR.DESTKEY = ASS._ID;

/*
** SUBORDINATE AND MASTER OPP VIEW
*/
CREATE OR REPLACE VIEW MASTER_SUB_OPP_VIEW AS 
SELECT OPP._ID OPPID,
	OPPR.DESTKEY SUBOPPID
FROM APP_OPPORTUNITIES OPP
LEFT OUTER JOIN RELATIONSHIPS OPPR ON 
	OPP._ID = OPPR.SOURCEKEY 
	AND OPPR.RELNAME = 'subordinateOpportunity'
	AND OPPR.SOURCETABLE = 'APP_OPPORTUNITIES'
WHERE OPP.ISSUBORDINATE <> 'true';

/*
** Test
*/
SELECT coalesce(SUBOPPID, OPPID) FROM MASTER_SUB_OPP_VIEW LIMIT 5;

/*
** Test
*/
SELECT * FROM OPP_CROSS_VIEW WHERE OPPID = '53039e457a4ff86443013181';
